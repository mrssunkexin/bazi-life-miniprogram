# 历史报告查看功能说明

## 功能概述

新增"查看报告"功能,用户可以查看自己提交过的所有报告,包括已发布和草稿状态的报告。

---

## 功能入口

### 首页入口

在首页标题下方添加了"📋 查看报告"按钮:

```
┌─────────────────────┐
│                     │
│  生辰五行报告        │
│  专业准确·科学解读   │
│                     │
│  [📋 查看报告]       │
│                     │
│  [表单...]          │
└─────────────────────┘
```

**位置**: [pages/index/index.wxml:7-10](pages/index/index.wxml#L7-L10)

**样式**:
- 半透明白色背景
- 圆角胶囊按钮
- 毛玻璃效果
- 点击跳转到历史报告列表

---

## 历史报告列表页面

### 页面结构

**文件位置**: `pages/history/`
- `history.wxml` - 页面结构
- `history.wxss` - 页面样式
- `history.js` - 页面逻辑
- `history.json` - 页面配置

### 功能特性

#### 1. 报告卡片展示

每个报告显示为一张卡片,包含以下信息:

```
┌─────────────────────────┐
│ 张三  [男]      [已发布] │
├─────────────────────────┤
│ 出生时间: 2025-12-09... │
│ 出生地点: 北京           │
│ 创建时间: 2025-12-09... │
├─────────────────────────┤
│ 甲子 乙丑 丙寅 丁卯   › │
└─────────────────────────┘
```

**卡片内容**:
- 头部: 姓名、性别、状态标签
- 主体: 出生时间、地点、创建时间
- 底部: 四柱预览、箭头指示

#### 2. 状态显示

报告有三种状态:

| 状态 | 说明 | 颜色 | 判断条件 |
|------|------|------|---------|
| **已发布** | 管理员已审核发布,可查看完整报告 | 绿色 | `status='published'` |
| **草稿** | AI已生成完成,等待管理员审核 | 黄色 | `status='draft'` 且 `fullContent` 有完整内容 |
| **生成中** | AI正在生成报告内容 | 蓝色 | `status='draft'` 且 `fullContent='报告生成中...'` |

**状态判断逻辑** ([pages/history/history.js:98-108](pages/history/history.js#L98-L108)):
```javascript
getStatusText(report) {
  if (report.status === 'published') {
    return '已发布';
  } else if (report.status === 'draft') {
    if (report.fullContent === '报告生成中...') {
      return '生成中';
    }
    return '草稿';
  }
  return '未知';
}
```

#### 3. 点击交互

**已发布报告**:
- 点击卡片 → 跳转到完整报告页面
- 显示完整的八字分析内容

**草稿/生成中报告**:
- 点击卡片 → 跳转到等待页面(复用result页面)
- 显示⏳沙漏图标和等待提示
- 显示公众号二维码

**实现代码** ([pages/history/history.js:51-67](pages/history/history.js#L51-L67)):
```javascript
onCardTap(e) {
  const report = e.currentTarget.dataset.report;

  if (report.status === 'published') {
    // 已发布:跳转到报告详情页
    wx.navigateTo({
      url: `/pages/result/result?reportId=${report.id}`
    });
  } else if (report.status === 'draft') {
    // 草稿状态:跳转到等待页面(复用result页面)
    wx.navigateTo({
      url: `/pages/result/result?reportId=${report.id}`
    });
  }
}
```

#### 4. 空状态

如果用户还没有提交过报告,显示空状态:

```
┌─────────────────────┐
│                     │
│        📋          │
│                     │
│   暂无报告记录       │
│                     │
│  [立即测算]         │
│                     │
└─────────────────────┘
```

点击"立即测算"按钮返回首页。

#### 5. 下拉刷新

支持下拉刷新功能,重新加载最新的报告列表。

**配置** ([pages/history/history.json](pages/history/history.json)):
```json
{
  "enablePullDownRefresh": true
}
```

---

## 数据流程

### 加载流程

```
用户点击"查看报告"
    ↓
调用 API: GET /api/reports
    ↓
返回所有报告列表
    ↓
按创建时间倒序排序
    ↓
渲染卡片列表
```

### 点击流程

```
用户点击报告卡片
    ↓
判断报告状态
    ↓
├─ 已发布 → 显示完整报告
└─ 草稿/生成中 → 显示等待页面
```

---

## API 调用

### 获取报告列表

**端点**: `GET /api/reports`

**响应格式**:
```json
{
  "success": true,
  "data": [
    {
      "id": "cm4vxxx...",
      "name": "张三",
      "gender": "male",
      "birthDate": "2025-12-09",
      "birthTime": "00:00",
      "city": "北京",
      "status": "published",
      "baziYear": "甲子",
      "baziMonth": "乙丑",
      "baziDay": "丙寅",
      "baziHour": "丁卯",
      "fullContent": "...",
      "createdAt": "2025-12-09T12:00:00.000Z"
    }
  ]
}
```

**实现位置**: [utils/api.js](utils/api.js)

---

## UI 设计

### 配色方案

**列表页面**:
- 背景: 渐变紫色 `linear-gradient(135deg, #667eea 0%, #764ba2 100%)`
- 卡片: 白色 `rgba(255, 255, 255, 0.95)`
- 阴影: `0 10rpx 30rpx rgba(0, 0, 0, 0.1)`

**状态标签**:
- 已发布: 绿色 `#52c41a` / 背景 `#e6f7e6`
- 草稿: 黄色 `#faad14` / 背景 `#fff7e6`
- 生成中: 蓝色 `#667eea` / 背景 `#e6f0ff`

### 响应式设计

- 卡片宽度: 自适应屏幕宽度
- 内边距: `40rpx`
- 圆角: `30rpx`
- 卡片间距: `30rpx`

---

## 测试步骤

### 1. 测试空状态

1. 新用户(没有提交过报告)
2. 点击首页的"📋 查看报告"
3. 应该看到:
   - 📋 图标
   - "暂无报告记录"文字
   - "立即测算"按钮

### 2. 测试已发布报告

1. 提交一个报告
2. 在管理后台发布该报告
3. 小程序中点击"查看报告"
4. 应该看到:
   - 报告卡片显示绿色"已发布"标签
   - 点击卡片进入完整报告页面
   - 可以看到完整的八字分析内容

### 3. 测试草稿报告

1. 提交一个报告
2. 等待AI生成完成(报告变为草稿状态)
3. 不要在后台发布
4. 小程序中点击"查看报告"
5. 应该看到:
   - 报告卡片显示黄色"草稿"标签
   - 点击卡片进入等待页面
   - 显示⏳沙漏图标和等待提示

### 4. 测试生成中报告

1. 提交一个报告
2. 立即点击"查看报告"(在AI生成完成之前)
3. 应该看到:
   - 报告卡片显示蓝色"生成中"标签
   - 点击卡片进入等待页面

### 5. 测试下拉刷新

1. 在历史报告列表页面
2. 下拉屏幕
3. 应该看到:
   - 刷新动画
   - 报告列表更新

---

## 文件清单

### 新增文件

1. **pages/history/history.wxml** - 列表页面结构
2. **pages/history/history.wxss** - 列表页面样式
3. **pages/history/history.js** - 列表页面逻辑
4. **pages/history/history.json** - 列表页面配置

### 修改文件

1. **pages/index/index.wxml** - 添加"查看报告"入口
2. **pages/index/index.wxss** - 添加入口按钮样式
3. **pages/index/index.js** - 添加跳转逻辑
4. **app.json** - 注册历史页面

---

## 用户流程示例

### 场景1: 首次使用

```
首页
  ↓ 点击"查看报告"
历史列表(空)
  ↓ 点击"立即测算"
返回首页
  ↓ 填写表单提交
等待页面
```

### 场景2: 查看已发布报告

```
首页
  ↓ 点击"查看报告"
历史列表
  ↓ 点击已发布报告
完整报告页面
  ↓ 查看八字分析
  ↓ 返回
历史列表
```

### 场景3: 查看生成中报告

```
首页
  ↓ 提交表单
等待页面
  ↓ 返回首页
首页
  ↓ 点击"查看报告"
历史列表(显示"生成中"标签)
  ↓ 点击报告卡片
等待页面(复用)
```

---

## 技术亮点

### 1. 状态判断逻辑

通过 `status` 和 `fullContent` 双重判断,准确区分三种状态:
- 生成中: `draft` + `'报告生成中...'`
- 草稿: `draft` + 完整内容
- 已发布: `published`

### 2. 复用等待页面

未发布的报告点击后复用 `pages/result/result` 页面,该页面会根据状态自动显示:
- 已发布 → 完整报告
- 草稿 → 等待界面

### 3. 时间格式化

创建时间显示为易读格式:
```
2025-12-09 20:23
```

### 4. 排序优化

报告按创建时间倒序排列,最新的报告在最上面。

---

## 注意事项

1. **API返回格式**:
   - 确保API返回 `{ success: true, data: [...] }` 格式
   - 代码中使用 `result.data || []` 兼容处理

2. **状态同步**:
   - 列表页面不会自动更新
   - 需要手动下拉刷新或重新进入页面

3. **点击区域**:
   - 整个卡片都可点击
   - 点击任意位置都会触发跳转

4. **空数据处理**:
   - 显示友好的空状态提示
   - 提供返回首页的快捷入口

---

**创建时间**: 2025-12-09
**最后更新**: 2025-12-09
